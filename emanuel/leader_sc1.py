__author__ = 'emanuel'

import numpy as np
from numpy.random import randn
from pandas import DataFrame, Series
from scipy.stats import spearmanr
from sklearn.linear_model import PassiveAggressiveRegressor
from sklearn.feature_selection import f_regression, SelectKBest
from sklearn.feature_selection import VarianceThreshold
from sklearn.cross_validation import ShuffleSplit
from sklearn.metrics import make_scorer
from dream_2014_functions import read_data_sets, save_gct_data, submit_solution, ev_code_sc1


def spearm_cor_func(y_true, y_pred):
    return spearmanr(y_true, y_pred)[0]

best_epsilon = 0.01
best_n_iter = 3
best_k = 3500
best_var = 0.65

# Folders
submission_filename_prefix = 'sc1_emanuel_phase2_'

genes_non_gratos = ['AAAS','AAK1','AARSD1','ABCA9','ABHD16A','ABI1','ABRA','ACACB','ACOX1','ACP6','ACRBP','ACTL7A','ACTR3B','ADAD2','ADAM21','ADAM33','ADAMTS10','ADAP1','ADCY6','ADCYAP1','ADCYAP1R1','ADRB2','AGR2','AHCYL1','AHR','AKR1CL1','ALDH1A1','ALG1L','AMBN','AMOTL1','AMPD2','AMZ1','ANKRD12','ANKRD29','ANKRD36C','ANKRD44','ANO10','ANP32C','ANXA4','ANXA9','AP3S1','APLNR','APOA2','APPL2','APTX','AQP12A','AREG','ARF5','ARG2','ARHGAP25','ARHGAP44','ARID1B','ARID3B','ARID4B','ARL13A','ARMC5','ARPC4-TTLL3','ARRB1','AS3MT','ASAP3','ASF1A','ASNSD1','ASPHD2','ATAD5','ATF7IP2','ATG5','ATIC','ATOH8','ATOX1','ATP10A','ATP2B1','ATP5S','ATP5SL','ATP6AP1','ATP9B','AUH','AZGP1','AZIN1','B3GNT3','BAMBI','BANF2','BCAM','BCAS1','BCKDK','BCL2L13','BCL6B','BHLHE40','BIRC8','BMPR1B','BMX','BNIP3','BOLA1','BPNT1','BRCA1','BRCA2','BSCL2','BSG','BTN1A1','C10orf111','C10orf28','C11orf16','C11orf30','C11orf73','C12orf45','C12orf54','C14orf105','C14orf43','C15orf5','C17orf77','C19orf43','C19orf75','C1QC','C1QTNF2','C1R','C1orf43','C22orf43','C3orf26','C3orf52','C4orf45','C6orf165','C6orf62','C8orf48','C9orf100','C9orf103','C9orf106','C9orf156','C9orf24','CA11','CACNA1B','CACNA1E','CACNA1I','CACNA2D1','CACNG8','CADM2','CALR','CAMK2D','CAMK4','CAMTA2','CAND2','CANX','CAPN2','CASC1','CASP2','CASP5','CASP6','CCDC102B','CCDC135','CCDC140','CCDC53','CCL24','CCL4','CCL4L2','CCR5','CCR8','CCRN4L','CD244','CD46','CD55','CDA','CDC26','CDC42EP2','CDC42EP5','CDK13','CDK6','CDKN1A','CDNF','CDO1','CDY1','CELA1','CEND1','CENPJ','CEP41','CFC1','CFHR1','CGGBP1','CHAC2','CHAMP1','CHRD','CHRNA3','CHUK','CILP2','CITED2','CKM','CLCN1','CLCN7','CLDN18','CLEC18B','CLIP1','CLK2P','CLN3','CMTM8','CNGB1','CNIH','CNKSR3','COMMD4','COMMD6','COQ2','COQ5','COX6C','CPAMD8','CPEB1','CPLX1','CPS1-IT1','CREM','CRLF1','CRLS1','CRTAM','CSF2RB','CSRNP3','CTAGE11P','CTAGE5','CTNNBL1','CTNND2','CTRC','CUEDC2','CUL4A','CXCL3','CYBB','CYLC2','CYP26C1','CYP4F3','DAAM2','DALRD3','DAP','DAZ1','DCAF4L2','DCBLD1','DCDC1','DCTN6','DDA1','DDAH2','DDX1','DDX31','DDX42','DECR1','DEFA1','DEK','DEPDC1B','DHRS7B','DIP2A','DIP2B','DIRAS2','DIRC2','DKK4','DLEC1','DLGAP4','DNAJB4','DNMT3B','DOCK10','DPM3','DPP4','DPY30','DRD3','DRGX','DSN1','DUSP26','DYM','DYNLL2','DZIP3','E2F5','EAF2','ECD','ECEL1','ECHDC2','EDAR','EDC3','EEF2K','EFCAB2','EFCAB5','EFNA4','EGR3','ELOVL4','EML4','EMP2','EN1','ENPEP','EPB41L1','ERMN','ERVV-1','ESRP2','ETV3','EXOC2','EXOC3','EYA3','F11','F2RL3','FAIM3','FAM115C','FAM116A','FAM153A','FAM161A','FAM174B','FAM184A','FAM206A','FAM20B','FAM217B','FAM47C','FAM48A','FAM65C','FAM75A7','FAM76A','FAN1','FARSA','FCAR','FCER1G','FCGR2C','FCN2','FER','FERMT1','FES','FGFBP1','FGFR2','FHDC1','FILIP1L','FKBP14','FLJ90757','FLRT1','FMO9P','FPR3','FRMD7','FTCD','FUT6','FUZ','FXR1','FZD2','GABARAPL1','GAD1','GALK1','GALP','GANAB','GATA4','GCNT2','GDF2','GDPD2','GEMIN7','GGT6','GGT7','GJA10','GJC1','GLI2','GLI3','GLS','GLT6D1','GLTSCR1','GLUD1','GLYCTK','GMCL1','GNAQ','GOLGA6C','GOLGA8B','GOPC','GOT1','GPI','GPR110','GPR143','GPR148','GPRC5C','GRAMD2','GRID2','GRIK5','GRTP1','GSC2','GSTTP1','GSTZ1','GTF2A1L','GTF2E2','GTPBP3','GTPBP5','GUCA1C','GUK1','GULP1','GUSBP11','GZF1','H1F0','HAND2','HAUS3','HBE1','HCAR1','HDAC11','HDC','HDGF','HIP1R','HIST1H2BD','HIST1H4J','HLA-DMA','HMG20B','HMGN2P46','HMGN3','HMGXB4','HNF1A','HNRNPA1','HNRNPA3','HOXB13','HPS3','HSFY1','HSFY2','HSP90AA1','HSPA14','HTR2A','IFI27','IFNA14','IFNAR1','IGF2','IGSF6','IKBKG','IL4I1','IL6','ILDR1','INPP1','INPP5J','INPPL1','INSIG1','INSR','IQCB1','IRF2','IRX3','ITGB3','JMJD7-PLA2G4B','JMY','JUND','KANSL1L','KBTBD3','KCNA2','KCNA3','KCNIP3','KCNJ15','KCNK7','KCNK9','KCNMA1','KCNS2','KCNT1','KCTD21','KDM3A','KDM3B','KDM5C','KIF13A','KIF18A','KIF5A','KIFAP3','KIN','KLF11','KLHL1','KLHL15','KLK12','KNG1','KRT35','KRT78','KRTAP1-3','KRTAP10-4','KRTAP11-1','KRTAP9-2','LAIR1','LAMC3','LAPTM4A','LCP1','LCTL','LDB1','LENEP','LENG9','LEPRE1','LGALS4','LHPP','LILRB5','LINC00158','LINC00336','LINC00342','LINC00474','LMAN1L','LMO3','LOC100287399','LOC152586','LOC339524','LOC390956','LOC440563','LOC645202','LOC727803','LOXL4','LPCAT4','LRFN5','LRPAP1','LRRC3','LRRC8D','LRRIQ3','LRTM1','LTK','LY75-CD302','MAGEB2','MALL','MAMDC2','MAML1','MAN2A2','MAOB','MAP4','MAPK1','MAPK8IP3','MAR6','MARVELD2','MAST1','MATN2','MBTD1','MC1R','MC5R','MCART6','MCCC1','MCOLN3','MDH1','MDK','MED16','MED26','MEST','METTL2A','MFSD10','MGC13053','MINK1','MINPP1','MLH1','MLXIPL','MMP26','MOB2','MOV10L1','MPPE1','MR1','MRAS','MRPL2','MRPL35','MRPL44','MTHFD2L','MTR','MURC','MUTED','MXRA5','MYBPC2','MYBPHL','MYC','MYF5','MYL2','MYO1E','MYT1','N6AMT1','NADSYN1','NANOS2','NAT2','NAT8L','NCBP2','NCOA7','NDFIP2','NDST2','NDUFB3','NEK1','NEU1','NEUROD6','NFXL1','NGFR','NIP7','NIT2','NKD1','NKRF','NLE1','NLRP11','NLRP7','NMBR','NOS2','NOSIP','NPR2','NR0B1','NR0B2','NR3C1','NR4A3','NRBP2','NRG1','NRTN','NSUN4','NUDT5','NUPL1','NUSAP1','OCEL1','OCLM','OLFM2','OLIG2','OPN1LW','OR12D2','OR1A2','OR1E1','OR1L4','OR4D11','OR4K17','OR51B2','OR56A1','OR7A17','ORC3','OSBPL8','OTOF','P2RX7','P4HA2','P4HB','PAIP2','PAPOLG','PARG','PARVB','PAX1','PAX5','PCDHGA2','PCGF3','PDCL3','PDE11A','PDGFRL','PDIA2','PDIA6','PDLIM7','PDZD8','PEAK1','PEBP4','PGLYRP2','PGM1','PHACTR1','PHACTR2','PHB','PHYHIP','PI16','PIDD','PIK3C3','PITPNC1','PKD2','PKD2L2','PKDCC','PKN1','PLA2G10','PLAU','PLCD3','PLCH1','PLCL1','PLCXD3','PLD4','PLEK','PLEKHB2','PLIN2','PLOD1','PLS3','PLXNC1','PNKD','PNP','POF1B','POGZ','POLD2','POLR2H','POM121','PON2','POPDC3','PPIG','PPM1J','PPM1L','PPP1CA','PPP1R1B','PPP3R1','PPRC1','PPT1','PPT2-EGFL8','PRDM4','PRDM5','PRDM7','PRDX6','PREPL','PRKACB','PRKCZ','PRMT8','PROK2','PROKR2','PROL1','PRR5L','PSMC3IP','PSPH','PTCD2','PTCHD4','PTGES3','PTGS2','PTPN5','PTPRE','PTPRU','PYCRL','PYGO2','QPCT','QRFPR','R3HDM2','RAB39A','RAB3IP','RAB40A','RAB43','RAB6C','RAB7A','RAB9B','RAD51D','RALA','RAPGEF3','RASGRP4','RBFA','RBM6','RBP5','RBP7','RCC1','RECQL4','REL','RER1','REXO2','RFXAP','RGS14','RHBDD2','RHBG','RHOB','RHOG','RIT1','RMND5A','RNASE1','RNASE8','RNF10','RNF182','RNF5P1','RNPC3','RORB','RPL36AL','RPRD1A','RRAGC','RRH','RSPH10B2','RTDR1','RTN1','RTP2','RUNX1','RUNX3','RUSC1','RXFP2','RYR2','SALL2','SAMD4A','SARNP','SCAMP5','SCCPDH','SCGB3A2','SCML2','SCN5A','SDCBP','SDF4','SDHB','SELE','SEMA3A','SEMA4A','SEMA4C','SEPHS2','SEPT5-GP1BB','SERPINB2','SERPINF1','SET','SFRP2','SHCBP1L','SIDT1','SLC16A9','SLC26A5','SLC29A2','SLC2A8','SLC32A1','SLC37A3','SLC38A11','SLC39A5','SLC47A2','SLC4A5','SLC6A13','SLC6A18','SLC7A1','SLC8A3','SLCO1B3','SMAD5','SMC1B','SNAP47','SNAPC1','SNX7','SOAT1','SORBS1','SOX6','SP100','SPACA5','SPAST','SPCS2','SPDYE3','SPEN','SPOCK2','SPOPL','SPPL2B','SPR','SRMS','SRP68','SRPK2','SRR','SRSF2','STARD10','STOM','STRA13','STX16','STYXL1','SUCLA2','SULT1C3','SULT4A1','SUN1','SUPT7L','SYNE2','SYNJ2BP-COX16','SYPL2','T','TAB3','TAC3','TADA3','TAF1C','TAF7L','TAGLN3','TAS2R50','TBC1D1','TBC1D15','TBC1D20','TBX22','TCF20','TCF21','TCP11','TEX14','TGFB2','THEMIS','THOC1','THPO','THUMPD1','TIAM1','TICAM1','TIMM21','TJP2','TM4SF18','TM4SF4','TMCO4','TMED8','TMEM126A','TMEM130','TMEM206','TMEM38A','TMEM45A','TMEM50B','TMEM68','TMOD4','TMPRSS11D','TMPRSS2','TMSB4Y','TNFAIP3','TNFRSF1A','TNFSF9','TNK2','TNP1','TP53BP1','TPD52','TPTE2','TRAM1L1','TRDMT1','TREML2','TRIM49L2','TRIP13','TRMT12','TRMT2B','TRO','TRPC3','TSFM','TSHR','TSLP','TSNAX-DISC1','TSPAN7','TSPAN9','TSPY2','TSPYL4','TSPYL5','TSSK6','TTC14','TTC23L','TTC33','TUBE1','TXNDC11','TXNDC15','UBE2G2','UBE2K','UBR2','UHMK1','UMODL1','UNC93B1','UROD','USE1','USP29','USP32P2','USP4','USP44','VCPIP1','VEZT','VPS72','VRK3','VRTN','VTA1','WBP2NL','WDR25','WDR5B','WDR83OS','WFDC10A','WNT1','WWOX','XIRP2','YIPF4','YTHDC2','YWHAE','ZBTB49','ZCRB1','ZDHHC17','ZEB1','ZFP3','ZFYVE28','ZNF12','ZNF197','ZNF248','ZNF263','ZNF266','ZNF273','ZNF281','ZNF302','ZNF34','ZNF385A','ZNF420','ZNF479','ZNF491','ZNF529','ZNF542','ZNF600','ZNF610','ZNF679','ZNF74','ZNF771','ZNF772','ZNF785','ZNF788','ZNF827','ZNFX1']

# Import data-sets
train_exp, train_cnv, train_ess, leader_exp, leader_cnv, prioritized_genes = read_data_sets()

# Setup
genes = train_ess.axes[1]
samples = leader_exp.axes[0]
predictions = DataFrame(None, index=genes, columns=samples)
spearman = make_scorer(spearm_cor_func, greater_is_better=True)

X_train_pre = train_exp
X_test_pre = leader_exp

# Filter by coeficient variation
var_thres = VarianceThreshold(best_var).fit(X_train_pre)
X_train_pre = var_thres.transform(X_train_pre)
X_test_pre = var_thres.transform(X_test_pre)

for gene in genes:
    # Assemble prediction variables
    X_train = X_train_pre
    y_train = train_ess.ix[:, gene]
    X_test = X_test_pre

    # Feature selection
    fs = SelectKBest(f_regression, k=best_k).fit(X_train, y_train)
    X_train = fs.transform(X_train)
    X_test = fs.transform(X_test)

    # Estimation
    clf = PassiveAggressiveRegressor(epsilon=best_epsilon, n_iter=best_n_iter).fit(X_train, y_train)
    y_pred = clf.predict(X_test)

    if gene in genes_non_gratos:
        y_pred *= -1

    # Store results
    predictions.ix[gene] = y_pred

    print gene

filename = save_gct_data(predictions, submission_filename_prefix)
print '[DONE]: Saved to file ' + filename

submit_solution(filename, filename.split('/')[1], ev_code_sc1)
print '[SUBMITED]'